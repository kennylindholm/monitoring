# SystemD Security Hardening Configuration
# Generated by Ansible - Do not edit manually
# This file provides additional security hardening for monitoring services

[Service]
{% if service_name is defined and service_name == 'node_exporter' %}
# Node Exporter specific settings - minimal security to allow metrics collection
NoNewPrivileges=yes
ProtectHome=yes
PrivateTmp=yes

{% else %}
# Security settings - relaxed for node_exporter to access system metrics
# Default security settings for other monitoring services
NoNewPrivileges=yes
ProtectSystem=strict
ProtectHome=yes
PrivateTmp=yes
PrivateDevices=yes
ProtectHostname=yes
ProtectClock=yes
ProtectKernelTunables=yes
ProtectKernelModules=yes
ProtectKernelLogs=yes
ProtectControlGroups=yes
RestrictNamespaces=yes
LockPersonality=yes
MemoryDenyWriteExecute=yes
RestrictRealtime=yes
RestrictSUIDSGID=yes
RemoveIPC=yes

# Restrict system calls
SystemCallFilter=@system-service
SystemCallFilter=~@debug @mount @cpu-emulation @obsolete @privileged @reboot @swap @raw-io

# Network restrictions
PrivateNetwork=no
RestrictAddressFamilies=AF_INET AF_INET6 AF_UNIX

# File system restrictions
ReadWritePaths={{ monitoring_base_dir }}
ReadWritePaths=/var/log
ReadWritePaths=/tmp
ReadOnlyPaths=/
BindReadOnlyPaths=/etc/ssl:/etc/ssl
BindReadOnlyPaths=/etc/ca-certificates:/etc/ca-certificates
{% endif %}

# Capabilities
CapabilityBoundingSet=CAP_NET_BIND_SERVICE
AmbientCapabilities=CAP_NET_BIND_SERVICE

# Process restrictions
UMask=0027

# Resource limits
LimitNOFILE={{ monitoring_max_open_files | default('65536') }}
LimitNPROC={{ monitoring_max_processes | default('32768') }}
LimitMEMLOCK=infinity

# Additional hardening based on service type
{% if ansible_service_mgr == "systemd" %}
# Modern systemd features (systemd 247+) - disabled for node_exporter
{% if service_name is not defined or service_name != 'node_exporter' %}
ProtectProc=invisible
ProcSubset=pid
{% endif %}
{% endif %}
