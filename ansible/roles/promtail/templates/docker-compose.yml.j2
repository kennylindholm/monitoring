version: '3.8'

services:
  promtail:
    image: {{ promtail_image }}
    container_name: {{ promtail_container_name }}
    ports:
      - "{{ promtail_port }}:{{ promtail_server_http_listen_port }}"
{% if promtail_server_grpc_listen_port > 0 %}
      - "{{ promtail_server_grpc_listen_port }}:{{ promtail_server_grpc_listen_port }}"
{% endif %}
{% if promtail_syslog_enabled %}
      - "{{ promtail_syslog_listen_address }}"
{% endif %}
    volumes:
{% for volume in promtail_volumes %}
      - {{ volume }}
{% endfor %}
{% for volume in promtail_additional_volumes %}
      - {{ volume }}
{% endfor %}
    command: -config.file=/etc/promtail/config.yml
    restart: {{ promtail_restart_policy }}
{% if promtail_network_external %}
    networks:
      - {{ promtail_network_name }}
{% endif %}
{% if promtail_env_vars %}
    environment:
{% for key, value in promtail_env_vars.items() %}
      - {{ key }}={{ value }}
{% endfor %}
{% endif %}
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:{{ promtail_server_http_listen_port }}/ready"]
      interval: {{ promtail_healthcheck_interval }}
      timeout: {{ promtail_healthcheck_timeout }}
      retries: {{ promtail_healthcheck_retries }}
      start_period: {{ promtail_healthcheck_start_period }}
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

{% if promtail_network_external %}
networks:
  {{ promtail_network_name }}:
    external: true
{% endif %}
